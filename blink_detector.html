<!DOCTYPE html><html><head><meta charset="utf-8">
  <title>Blink Detector‚ÄØ(v3)</title>
  
  <!-- Mediapipe UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  
  <style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:sans-serif}
  #wrap{position:relative;width:100%;height:100%}
  video,canvas{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #hud{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.55);color:#fff;padding:8px 12px;border-radius:8px;font-size:15px;line-height:1.4;min-width:150px}
  #hud.ok{border-left:6px solid #30c750}
  #hud.drowsy{border-left:6px solid #ffc107}
  #hud.sleep{border-left:6px solid #ff3b30}
  #history{position:absolute;bottom:10px;left:10px;width:210px;max-height:40%;overflow:auto;background:rgba(0,0,0,.4);color:#fff;padding:6px 8px;border-radius:6px;font-size:13px}
  #history h4{margin:0 0 4px;font-size:14px}
  #download{position:absolute;top:10px;right:10px;background:#0078ff;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:14px}
  </style></head><body>
  <div id="wrap">
    <video class="input_video" playsinline></video>
    <canvas class="output_canvas"></canvas>
    <div id="hud" class="ok">Loading‚Ä¶</div>
    <button id="download">üíæ‚ÄØ–°–∫–∞—á–∞—Ç—å‚ÄØHTML</button>
    <div id="history"><h4>–ò—Å—Ç–æ—Ä–∏—è</h4><ul id="log" style="margin:0;padding-left:16px"></ul></div>
  </div>
  
  <script>
  /* -------- helpers -------- */
  function ear(pts,L=true){
    const p=i=>pts[i];
    const a=L?p(159):p(386), b=L?p(145):p(374), c=L?p(133):p(362), d=L?p(33):p(263);
    return Math.hypot(a.x-b.x,a.y-b.y)/Math.hypot(c.x-d.x,c.y-d.y);
  }
  function addLog(text){const li=document.createElement('li');li.textContent=text;log.prepend(li);if(log.children.length>10)log.removeChild(log.lastChild);}
  const video=document.querySelector('.input_video'),canvas=document.querySelector('.output_canvas'),
        ctx=canvas.getContext('2d'),hud=document.getElementById('hud'),log=document.getElementById('log');
  
  /* -------- FaceMesh -------- */
  const faceMesh=new FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
  faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:.6,minTrackingConfidence:.6});
  
  /* -------- blink + drowsy logic -------- */
  let blinks=0, closedFrames=0, buf=[], BUF_SIZE=150; // 150 –∫–∞–¥—Ä–æ–≤ ‚âà 5¬†—Å
  faceMesh.onResults(res=>{
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    ctx.drawImage(res.image,0,0,canvas.width,canvas.height);
  
    if(res.multiFaceLandmarks.length){
      const lm=res.multiFaceLandmarks[0];
      const e=(ear(lm,true)+ear(lm,false))/2;
      buf.push(e); if(buf.length>BUF_SIZE)buf.shift();
      const avg=buf.reduce((a,b)=>a+b,0)/buf.length;
  
      if(e<0.23){closedFrames++;}else{if(closedFrames>2){blinks++;addLog(`–ú–æ—Ä–≥–Ω—É–ª¬†#${blinks}`);}closedFrames=0;}
  
      /* smarter status */
      let status='OK',cls='ok';
      if(avg<0.20&&closedFrames>60){status='–ó–∞—Å—ã–ø–∞–µ—Ç‚Ä¶';cls='sleep';}
      else if(avg<0.22||closedFrames>2){status='–ü—Ä–∏–∫—Ä—ã–ª¬†–≥–ª–∞–∑–∞';cls='drowsy';}
      hud.className=cls;
      hud.innerHTML=`<strong>–ú–æ—Ä–≥–∞–Ω–∏–π:</strong>¬†${blinks}<br><strong>EAR:</strong>¬†${e.toFixed(3)}<br><strong>–°—Ç–∞—Ç—É—Å:</strong>¬†${status}`;
    }
  });
  
  /* -------- camera -------- */
  new Camera(video,{onFrame:async()=>{await faceMesh.send({image:video});},width:640,height:480}).start();
  
  /* -------- download button -------- */
  document.getElementById('download').onclick=()=>location.href='blink_detector.html';
  </script></body></html>
  